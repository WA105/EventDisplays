!function(e,r){"object"==typeof exports&&"object"==typeof module?module.exports=r():"function"==typeof define&&define.amd?define([],r):"object"==typeof exports?exports["webworker-promise-pool"]=r():e.WebWorkerPromisePool=r()}(this,function(){return function(e){function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}var t={};return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},r.p="",r(r.s=0)}([function(e,r,t){"use strict";function n(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}function o(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var i=function(){function e(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw i}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),a=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),u=t(1),s=function(){function e(r){var t=r.create,n=r.maxThreads,i=r.terminateAfterDelay,a=r.maxConcurrentPerWorker;o(this,e),this._queue=[],this._workers=[],this._createWorker=t,this._maxThreads=n,this._terminateAfterDelay=i,this._maxConcurrentPerWorker=a;var u=this._createWebWorker();this._workers.push(u)}return a(e,[{key:"exec",value:function(){for(var e=this,r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];var o=this.getFreeWorkerOrCreate();return o?this._exec(o,"exec",t):new Promise(function(r){return e._queue.push(["exec",t,r])})}},{key:"postMessage",value:function(){for(var e=this,r=arguments.length,t=Array(r),n=0;n<r;n++)t[n]=arguments[n];var o=this.getFreeWorkerOrCreate();return o?this._exec(o,"postMessage",t):new Promise(function(r){return e._queue.push(["postMessage",t,r])})}},{key:"_exec",value:function(e,r,t){var o=this;return new Promise(function(i,a){e[r].apply(e,n(t)).then(function(r){o._onWorkDone(e),i(r)}).catch(function(r){o._onWorkDone(e),a(r)})})}},{key:"_onWorkDone",value:function(){if(this._queue.length)for(var e=void 0;this._queue.length&&(e=this.getFreeWorkerOrCreate());){var r=this._queue.shift(),t=i(r,3),n=t[0],o=t[1],a=t[2];a(this._exec(e,n,o))}var u=this.getAllFreeWorkers();u.length&&this._waitAndRemoveWorkers(u)}},{key:"_waitAndRemoveWorkers",value:function(e){var r=this;setTimeout(function(){e=e.filter(function(e){return e.isFree()}).slice(0,r._workers.length-1),e.forEach(function(e){return r._removeWorker(e)})},this._terminateAfterDelay)}},{key:"_removeWorker",value:function(e){this._workers=this._workers.filter(function(r){return r._id!==e._id}),e.terminate()}},{key:"getAllFreeWorkers",value:function(){var e=this;return this._workers.filter(function(r){return r.jobsLength()<e._maxConcurrentPerWorker})}},{key:"getFreeWorkerOrCreate",value:function(){var e=this,r=this._workers.find(function(r){return r.jobsLength()<e._maxConcurrentPerWorker});if(!r&&this._workers.length<this._maxThreads){var t=this._createWebWorker();return this._workers.push(t),t}return r}},{key:"_createWebWorker",value:function(){return new u(this._createWorker())}}],[{key:"create",value:function(r){return r.create||(r.create=function(){return new Worker(r.src)}),r.terminateAfterDelay||(r.terminateAfterDelay=5e3),r.maxThreads||(r.maxThreads=2),r.maxConcurrentPerWorker||(r.maxConcurrentPerWorker=1),new e(r)}}]),e}();e.exports=s},function(e,r,t){"use strict";function n(e){return Array.isArray(e)?e:Array.from(e)}function o(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}function i(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function a(e,r){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!r||"object"!=typeof r&&"function"!=typeof r?e:r}function u(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Super expression must either be null or a function, not "+typeof r);e.prototype=Object.create(r&&r.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),r&&(Object.setPrototypeOf?Object.setPrototypeOf(e,r):e.__proto__=r)}var s=function(){function e(e,r){var t=[],n=!0,o=!1,i=void 0;try{for(var a,u=e[Symbol.iterator]();!(n=(a=u.next()).done)&&(t.push(a.value),!r||t.length!==r);n=!0);}catch(e){o=!0,i=e}finally{try{!n&&u.return&&u.return()}finally{if(o)throw i}}return t}return function(r,t){if(Array.isArray(r))return r;if(Symbol.iterator in Object(r))return e(r,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),c=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),f=function e(r,t,n){null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,t);if(void 0===o){var i=Object.getPrototypeOf(r);return null===i?void 0:e(i,t,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},l=t(2),h=function(e){function r(e){i(this,r);var t=a(this,(r.__proto__||Object.getPrototypeOf(r)).call(this));return t._messageId=1,t._messages=new Map,t._worker=e,t._worker.onmessage=t._onMessage.bind(t),t._id=Math.ceil(1e7*Math.random()),t}return u(r,e),c(r,[{key:"terminate",value:function(){this._worker.terminate()}},{key:"isFree",value:function(){return 0===this._messages.size}},{key:"jobsLength",value:function(){return this._messages.size}},{key:"exec",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],o=arguments[3];return new Promise(function(i,a){var u=t._messageId++;t._messages.set(u,[i,a,o]),t._worker.postMessage([u,r,e],n||[])})}},{key:"postMessage",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,r=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2];return new Promise(function(o,i){var a=r._messageId++;r._messages.set(a,[o,i,n]),r._worker.postMessage([a,e],t||[])})}},{key:"emit",value:function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),n=1;n<r;n++)t[n-1]=arguments[n];this._worker.postMessage({eventName:e,args:t})}},{key:"_onMessage",value:function(e){if(!Array.isArray(e.data)&&e.data.eventName){var t;return(t=f(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"emit",this)).call.apply(t,[this,e.data.eventName].concat(o(e.data.args)))}var i=n(e.data),a=i[0],u=i.slice(1);if(1===a)this._onEvent.apply(this,o(u));else{if(0!==a)throw new Error("Wrong message type '"+a+"'");this._onResult.apply(this,o(u))}}},{key:"_onResult",value:function(e,r,t){var n=this._messages.get(e),o=s(n,2),i=o[0],a=o[1];return this._messages.delete(e),1===r?i(t):a(t)}},{key:"_onEvent",value:function(e,r,t){var n=this._messages.get(e),o=s(n,3),i=o[2];i&&i(r,t)}}]),r}(l);e.exports=h},function(e,r,t){"use strict";function n(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}var o=function(){function e(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(r,t,n){return t&&e(r.prototype,t),n&&e(r,n),r}}(),i=function(){function e(){n(this,e),Object.defineProperty(this,"__listeners",{value:{},enumerable:!1,writable:!1})}return o(e,[{key:"emit",value:function(e){for(var r=arguments.length,t=Array(r>1?r-1:0),n=1;n<r;n++)t[n-1]=arguments[n];var o=!0,i=!1,a=void 0;try{for(var u,s=this.__listeners[e][Symbol.iterator]();!(o=(u=s.next()).done);o=!0){u.value.apply(void 0,t)}}catch(e){i=!0,a=e}finally{try{!o&&s.return&&s.return()}finally{if(i)throw a}}return this}},{key:"once",value:function(e,r){var t=this,n=function n(){t.off(e,n),r.apply(void 0,arguments)};return this.on(e,n)}},{key:"on",value:function(e,r){return this.__listeners[e]||(this.__listeners[e]=[]),this.__listeners[e].push(r),this}},{key:"off",value:function(e,r){return this.__listeners[e]=r?this.__listeners[e].filter(function(e){return e!==r}):[],this}}]),e}();e.exports=i}])});